<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <base href="../" >

    <title>INSPINIA - Landing Page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/plugins/ladda/ladda-themeless.min.css" rel="stylesheet">

    <!-- https://tslabkz.github.io/inspinia -->

    <!-- Animation CSS -->
    <link href="css/animate.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
</head>
<body id="page-top" class="landing-page no-skin-config" style="background-color: #f3f3f4;">

            <div class="row border-bottom white-bg page-heading">
                <div class="col-sm-10">
                    <h2>Подтверждение измененных данных</h2>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="./index.html">Главная</a>
                        </li>
                        <li class="breadcrumb-item active">
                            <strong>Страница подтверждения</strong>
                        </li>
                    </ol>
                </div>
                <div class="col-sm-2">
                    <div class="title-action">
                        <a href="./index.html" class="btn btn-primary">Главная</a>
                    </div>
                </div>
            </div>

<div class="gray-bg">

    <section  class="container features">

        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="navy-line"></div>
                <h1>Список запросов</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12" >
                
                <div class="ibox ">
                    <div class="ibox-title">
                        <h5>Список запросов <small>Показывает как ведет себя форма.</small></h5>
                    </div>


                    <div class="ibox-content">
                        <div class="row">
                            <div class="container"> 

                    <div id="spinner-loader-el"  style="display: none;" >
                        <div class="sk-spinner sk-spinner-double-bounce sk-loading">
                            <div class="sk-double-bounce1"></div>
                            <div class="sk-double-bounce2"></div>
                        </div>
                    </div>

    <!-- start -->
    
    <div id="update-query-list-box"></div> 
    <div class="alert alert-info" id="update-query-list-not-found" style="display: none;">Список запросов не найден</div>
    <!-- end -->



                            </div>
                        </div>
                    </div>
                </div>
<!-- modal:start --> 
<div class="modal inmodal fade" id="confirmPersonalFormModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Форма подтверждения данных</h4>
                <small class="font-bold">Здесь вы можете подтвердить и подправить измененные персональные данные.</small>
            </div>
            <div class="modal-body">

                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Имя</label> 
                    <label class="col-sm-4 col-form-label profile-label-name"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-name">
                        <input type="hidden" class="form-control" name="user-confirm-form-name">
                    </div>
                </div>
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Фамилия</label>
                    <label class="col-sm-4 col-form-label profile-label-surname"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-surname">
                        <input type="hidden" class="form-control" name="user-confirm-form-surname">
                    </div>
                </div>
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Отчество</label>
                    <label class="col-sm-4 col-form-label profile-label-lastname"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-lastname">
                        <input type="hidden" class="form-control" name="user-confirm-form-lastname">
                    </div>
                </div>
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">День рождения</label>
                    <label class="col-sm-4 col-form-label profile-label-birthdate"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-birthdate">
                        <input type="hidden" class="form-control" name="user-confirm-form-birthdate">
                    </div>
                </div> 
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Резидент</label>
                    <label class="col-sm-4 col-form-label profile-label-resident"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-resident">
                        <input type="hidden" class="form-control" name="user-confirm-form-resident">
                    </div>
                </div>
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Национальность</label>
                    <label class="col-sm-4 col-form-label profile-label-nationality"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-nationality">
                        <input type="hidden" class="form-control" name="user-confirm-form-nationality">
                    </div>
                </div>
                
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Пол</label>
                    <label class="col-sm-4 col-form-label profile-label-gender"></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="confirm-form-gender">
                        <input type="hidden" class="form-control" name="user-confirm-form-gender">
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <input type="hidden" class="form-control" name="confirm-form-iin" >
                <button type="button" class="btn btn-white" data-dismiss="modal">Закрыть</button>
                
                <button class="ladda-button btn btn-danger" data-style="slide-left" id="confirm-data-form-cancel">
                    <span class="ladda-label">Отменить изменения</span><span class="ladda-spinner"></span>
                    <div class="ladda-progress" style="width: 0px;"></div>
                </button>

                <button class="ladda-button btn btn-info" data-style="slide-left" id="confirm-data-form-submit">
                    <span class="ladda-label">Сохранить</span><span class="ladda-spinner"></span>
                    <div class="ladda-progress" style="width: 0px;"></div>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- modal:end --> 
            </div>
        </div>
    </section>
</div>

<!-- Mainly scripts -->
<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="js/inspinia.js"></script>
<script src="js/plugins/pace/pace.min.js"></script>
<script src="js/plugins/wow/wow.min.js"></script>

<!-- Ladda -->
<script src="js/plugins/ladda/spin.min.js"></script>
<script src="js/plugins/ladda/ladda.min.js"></script>
<script src="js/plugins/ladda/ladda.jquery.min.js"></script>

<script src="js/project.js"></script>


<script type="text/javascript">

    $(document).ready(function() {
        let confirmProps = ['name', 'surname', 'lastname', 
            'birthdate', 'resident', 'nationality', 'gender'];
        // показываем модальную форму
        $("body").on('click', '.show-modal-to-confirm', function(e) {
            e.preventDefault();
            let confirmData = JSON.parse($(this).next('span.confirm-data').text());
            let profileData = JSON.parse($(this).next().next('span.profile-data').text());
            let confirmItems = JSON.parse(confirmData.data);
            $("input[name=confirm-form-iin]").val(profileData.uuid);
            confirmProps.forEach(function(prop) {
                $(".profile-label-" + prop).text(profileData[prop]);
                let propValue = '';
                if (confirmItems[prop]) {
                    propValue = confirmItems[prop];
                }
                $("input[name=confirm-form-"+prop+"]").val(propValue);
                $("input[name=user-confirm-form-"+prop+"]").val(propValue);
            });
        });
        // отмена подтвержденных данных
        $("#confirm-data-form-cancel").click(function(e) {
            e.preventDefault();
            $("#confirm-data-form-submit").attr('disabled', true);
            var l = Ladda.create(this);
            l.start();
            let data = {};
            data['uuid'] = $("input[name=confirm-form-iin]").val();
            data['cancel'] = 1;
            let url = project.buildUrl('user.updateQueryConfirm', data);
            $.get(url, function(response) { 
                if (response.success) { 
                    console.log("changes canceled");
                } 
            })
            .fail(function(response) {
            })
            .always(function() {
                l.stop(); 
                $("#confirm-data-form-submit").removeAttr('disabled');
            }); 
        });
        // отправка подтвержденных данных
        // 
        $("#confirm-data-form-submit").click(function(e){
            e.preventDefault();
            $("#confirm-data-form-cancel").attr('disabled', true);
            var l = Ladda.create(this); 
            l.start(); 
            let data = {}; 
            data['uuid'] = $("input[name=confirm-form-iin]").val(); 
            data['corrected_data'] = ''; 
            let correctedData = {};
            // 
            confirmProps.forEach(function(prop) { 
                // confirmValue - то что изменил пользователь 
                // adminValue - то что поменял админ 
                let confirmValue = $("input[name=user-confirm-form-"+prop+"]").val(); 
                let adminValue = $("input[name=confirm-form-"+prop+"]").val(); 
                if (confirmValue != adminValue) {
                    correctedData[prop] = adminValue; 
                }
            });
            data['corrected_data'] = JSON.stringify(correctedData); 
            // setTimeout(function(){
            //     l.stop();
            //     $("#confirm-data-form-cancel").removeAttr('disabled');
            // }, 3000); 
            let url = project.buildUrl('user.updateQueryConfirm', data); 
            $.get(url, function(response) { 
                if (response.success) {  
                    // window.location.reload(); 
                } 
            })
            .fail(function(response) {
            })
            .always(function() {
                l.stop(); 
                $("#confirm-data-form-cancel").removeAttr('disabled');
            }); 
        });
    });

    if (isExpired()) {
        loadFromRemote();
    } else {
        loadFromLocal()
    }
    
    function isExpired() {
        let listData = window.localStorage.getItem('updateQueryList');
        if (!listData) {
            return true;
        }
        let loadedTimeExpire = window.localStorage.getItem('updateQueryListLoadedTimeExpire');
        if (!loadedTimeExpire) {
            return true;
        }
        let currentTime = (new Date()).getTime();
        let res = currentTime > loadedTimeExpire; 
        return res;
    }
    
    function loadFromLocal() {
        let listData = window.localStorage.getItem('updateQueryList');
        if (!listData) {
            showErrorAlert('Local data not found');
            return true;
        };
        buildActionTables(JSON.parse(listData));
    }
    
    function loadFromRemote() { 
        let url = project.buildUrl('user.updateQueryActiveList', {});
        $("#spinner-loader-el").show();
        hideErrorAlert('');
        $.get(url, function(response){
            if (response.success) {
                buildActionTables(response.data);
                window.localStorage.setItem('updateQueryList', JSON.stringify(response.data));
                let timeObject = new Date();
                // здесь можно установить сколько времени хранить локальные данные
                let seconds = 10; // 300 - 5 минут
                const milliseconds = seconds * 1000; // 10 seconds = 10000 milliseconds
                timeObject = new Date(timeObject.getTime() + milliseconds);
                let expireTime = timeObject.getTime();
                window.localStorage.setItem('updateQueryListLoadedTimeExpire', expireTime);
                //
            } else {
                showErrorAlert('');
            }
        })
        .fail(function(response) {
            showErrorAlert('');
        })
        .always(function() {
            $("#spinner-loader-el").hide();
        });
    
    } // function loadFromRemote
    
    
        function  showErrorAlert(message) {
            $("#alert-process-failed").find('span').text(message);
            $("#alert-process-failed").show();
        }
    
        function  hideErrorAlert() {
            $("#alert-process-failed").hide();
            $("#alert-process-failed").find('span').text('');
        }
    
        function buildActionTables(data) {
            let boxContent = getBoxTemplate();
            let content = '';
            data.forEach(function(item) {
                let confirm = item.confirm;
                let profile = item.profile;
                let rowContent = getRowTemplate();
                rowContent = rowContent.replace('%iin%', confirm.iin);
                let d = new Date(confirm.created_at);
                rowContent = rowContent.replace('%date%', 
                d.getDate() + '-' + d.getMonth() + '-' + d.getYear()
                + ' ' + d.getHours() + ':' + d.getMinutes());
                rowContent = rowContent.replace('%iin%', confirm.iin);
                rowContent = rowContent.replace('%confirm%', JSON.stringify(confirm));
                rowContent = rowContent.replace('%profile%', JSON.stringify(profile));
                content = content + rowContent;
            });
            boxContent = boxContent.replace('%content%', content);
            $("#update-query-list-box").append(boxContent);
        }
    
        function getBoxTemplate() {
            return '<table class="table">' +
                            '<thead>' +
                            '<tr>' +
                                '<th>ИИН</th>' +
                                '<th>Дата</th>' +
                                '<th>&nbsp;</th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody>' +
                                '%content%'+
                            '</tbody>'+
                    '</table>'+
                '</div>'+
            '</div>';
        }
    
        function getRowTemplate() {
            return '<tr>'+
                '<td>%iin%</td>'+
                '<td>%date%</td>'+
                '<td>'+
                    '<a href="#" class="show-modal-to-confirm" data-toggle="modal" data-target="#confirmPersonalFormModal" >Ответить</a>'+
                    '<span class="confirm-data" style="display:none;" >%confirm%</span>' +
                    '<span class="profile-data" style="display:none;" >%profile%</span>' +
                '</td>'+
            '</tr>';
        }
    
    </script>


</body>
</html>
